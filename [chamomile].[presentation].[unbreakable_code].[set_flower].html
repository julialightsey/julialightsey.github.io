<div><span style="font-family: Courier New; font-size: 10pt;">
<span style="color: green; font-style: italic; ">/*
<br/>
<br/>
<br/>&nbsp;&nbsp;truncate&nbsp;table&nbsp;unbreakable_code.flower
<br/>&nbsp;&nbsp;&nbsp;&nbsp;declare&nbsp;@error_stack&nbsp;xml;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;execute&nbsp;[unbreakable_code].[set_flower]
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@flower&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=N'red'
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;@color&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;='white'
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;@error_stack=@error_stack&nbsp;output
<br/>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;@error_stack&nbsp;as&nbsp;N'@error_stack';
<br/>&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;*
<br/>&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;&nbsp;&nbsp;[unbreakable_code].[flower];&nbsp;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;
<br/>
<br/>
<br/>&nbsp;&nbsp;All&nbsp;content&nbsp;is&nbsp;licensed&nbsp;as&nbsp;[chamomile]&nbsp;(http://www.KELightsey.com/license.html)&nbsp;and&nbsp;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;copyright&nbsp;Katherine&nbsp;Elizabeth&nbsp;Lightsey,&nbsp;1959-2014&nbsp;(aka;&nbsp;my&nbsp;life),&nbsp;all&nbsp;rights&nbsp;reserved,
<br/>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;as&nbsp;open&nbsp;source&nbsp;under&nbsp;the&nbsp;GNU&nbsp;Affero&nbsp;GPL&nbsp;(http://www.gnu.org/licenses/agpl-3.0.html).
<br/>&nbsp;&nbsp;---------------------------------------------
<br/>
<br/>&nbsp;&nbsp;--
<br/>&nbsp;&nbsp;--&nbsp;&nbsp;description
<br/>&nbsp;&nbsp;---------------------------------------------
<br/>&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;demonstration&nbsp;of&nbsp;the&nbsp;technique&nbsp;required&nbsp;to&nbsp;implement&nbsp;transactions
<br/>&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;production&nbsp;code&nbsp;while&nbsp;allowing&nbsp;unit&nbsp;unbreakable_codeing&nbsp;without&nbsp;impacting&nbsp;production&nbsp;state.&nbsp;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;referred&nbsp;to&nbsp;as&nbsp;non-destructive&nbsp;unbreakable_codeing.
<br/>
<br/>&nbsp;&nbsp;--
<br/>&nbsp;&nbsp;--&nbsp;&nbsp;notes
<br/>&nbsp;&nbsp;---------------------------------------------
<br/>&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;unbreakable_code&nbsp;is&nbsp;designed&nbsp;to&nbsp;be&nbsp;run&nbsp;incrementally&nbsp;a&nbsp;code&nbsp;block&nbsp;at&nbsp;a&nbsp;time.&nbsp;
<br/>&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;blocks&nbsp;are&nbsp;delineated&nbsp;as:
<br/>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;code&nbsp;block&nbsp;begin
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------------------
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<run&nbsp;code&nbsp;here>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------------------
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;code&nbsp;block&nbsp;end
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--
<br/>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;sys.dm_tran_active_transactions&nbsp;requires&nbsp;VIEW&nbsp;SERVER&nbsp;STATE&nbsp;permission&nbsp;on&nbsp;the&nbsp;server.
<br/>&nbsp;&nbsp;
<br/>&nbsp;&nbsp;--
<br/>&nbsp;&nbsp;--&nbsp;references
<br/>&nbsp;&nbsp;---------------------------------------------
<br/>&nbsp;&nbsp;&nbsp;&nbsp;sys.dm_tran_active_transactions&nbsp;(Transact-SQL)&nbsp;-&nbsp;http://msdn.microsoft.com/en-us/library/ms174302.aspx
<br/>&nbsp;&nbsp;&nbsp;&nbsp;Unit&nbsp;testing&nbsp;-&nbsp;http://en.wikipedia.org/wiki/Unit_unbreakable_codeing
<br/>*/</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;code&nbsp;block&nbsp;begin</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/><span style="color: blue; ">use</span>&nbsp;<span style="color: maroon; ">[chamomile]</span><span style="color: silver; ">;</span>
<br/><span style="color: maroon; ">go</span>
<br/><span style="color: blue; ">if</span>&nbsp;<span style="color: #FF0080; font-weight: bold; ">schema_id</span><span style="color: maroon; ">(</span><span style="color: red; ">N'unbreakable_code'</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: blue; ">is</span>&nbsp;<span style="color: blue; ">null</span>
<br/>&nbsp;&nbsp;<span style="color: blue; ">execute</span>&nbsp;<span style="color: maroon; ">(</span><span style="color: red; ">N'create&nbsp;schema&nbsp;unbreakable_code'</span><span style="color: maroon; ">)</span><span style="color: silver; ">;</span>
<br/><span style="color: maroon; ">go</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;code&nbsp;block&nbsp;end</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/><span style="color: blue; ">if</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">object_id</span><span style="color: maroon; ">(</span><span style="color: red; ">N'[unbreakable_code].[set_flower]'</span><span style="color: silver; ">,</span>&nbsp;<span style="color: red; ">N'P'</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: blue; ">is</span>&nbsp;<span style="color: blue; ">not</span>&nbsp;<span style="color: blue; ">null</span>
<br/>&nbsp;&nbsp;<span style="color: blue; ">drop</span>&nbsp;<span style="color: blue; ">procedure</span>&nbsp;<span style="color: maroon; ">[unbreakable_code]</span><span style="color: silver; ">.</span><span style="color: maroon; ">[set_flower]</span><span style="color: silver; ">;</span>
<br/><span style="color: maroon; ">go</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;code&nbsp;block&nbsp;begin</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/><span style="color: blue; ">create</span>&nbsp;<span style="color: blue; ">procedure</span>&nbsp;<span style="color: maroon; ">[unbreakable_code]</span><span style="color: silver; ">.</span><span style="color: #FF0080; font-weight: bold; ">[set_flower]</span>
<br/>&nbsp;&nbsp;<span style="color: #8000FF; ">@flower</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: black; font-style: italic; ">[sysname]</span>
<br/>&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@color</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: black; font-style: italic; ">[sysname]</span>
<br/>&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@stack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: black; font-style: italic; ">[xml]</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: blue; ">null</span>&nbsp;<span style="color: maroon; ">output</span>
<br/>&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@error_stack</span>&nbsp;<span style="color: black; font-style: italic; ">[xml]</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: blue; ">null</span>&nbsp;<span style="color: maroon; ">output</span>
<br/><span style="color: blue; ">as</span>
<br/>&nbsp;&nbsp;<span style="color: blue; ">begin</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">set</span>&nbsp;<span style="color: blue; ">transaction</span>&nbsp;<span style="color: maroon; ">isolation</span>&nbsp;<span style="color: maroon; ">level</span>&nbsp;<span style="color: maroon; ">serializable</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">set</span>&nbsp;<span style="color: maroon; ">nocount</span>&nbsp;<span style="color: blue; ">on</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">declare</span>&nbsp;<span style="color: #8000FF; ">@message</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: black; font-style: italic; ">[nvarchar]</span><span style="color: maroon; ">(</span><span style="color: maroon; ">max</span><span style="color: maroon; ">)</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@application_message</span>&nbsp;<span style="color: black; font-style: italic; ">[xml]</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;create&nbsp;unique&nbsp;transaction&nbsp;name,&nbsp;must&nbsp;be&nbsp;32&nbsp;characters&nbsp;or&nbsp;less</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;todo&nbsp;-&nbsp;necessary&nbsp;for&nbsp;parallel&nbsp;operations?</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@transaction</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: black; font-style: italic; ">[nvarchar]</span><span style="color: maroon; ">(</span><span style="color: black; ">32</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: red; ">N'set_flower_'</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">cast</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">round</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">rand</span><span style="color: maroon; ">(</span><span style="color: maroon; ">)</span><span style="color: silver; ">*</span><span style="color: black; ">100000</span><span style="color: silver; ">,</span>&nbsp;<span style="color: silver; ">-</span><span style="color: black; ">1</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: blue; ">as</span>&nbsp;<span style="color: black; font-style: italic; ">[sysname]</span><span style="color: maroon; ">)</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'_'</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">cast</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">datepart</span><span style="color: maroon; ">(</span><span style="color: maroon; ">millisecond</span><span style="color: silver; ">,</span>&nbsp;<span style="color: blue; ">current_timestamp</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: blue; ">as</span>&nbsp;<span style="color: black; font-style: italic; ">[sysname]</span><span style="color: maroon; ">)</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">set</span>&nbsp;<span style="color: #8000FF; ">@error_stack</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: blue; ">null</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;Check&nbsp;to&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;an&nbsp;existing&nbsp;transaction&nbsp;in&nbsp;this&nbsp;context.&nbsp;Only&nbsp;if&nbsp;there&nbsp;is&nbsp;not</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;&nbsp;do&nbsp;we&nbsp;start&nbsp;a&nbsp;new&nbsp;transaction.</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;Name&nbsp;the&nbsp;transaction&nbsp;so&nbsp;we&nbsp;can&nbsp;easily&nbsp;find&nbsp;it&nbsp;when&nbsp;we&nbsp;need&nbsp;to&nbsp;rollback&nbsp;or&nbsp;commit.</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">if</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">@@trancount</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: black; ">0</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">begin</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">begin</span>&nbsp;<span style="color: blue; ">transaction</span>&nbsp;<span style="color: #8000FF; ">@transaction</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">select</span>&nbsp;<span style="color: red; ">N'began&nbsp;transaction&nbsp;('</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #8000FF; ">@transaction</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N')&nbsp;(('</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #FF0080; font-weight: bold; ">object_schema_name</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">@@procid</span><span style="color: maroon; ">)</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'].['</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">object_name</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">@@procid</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'])'</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">end</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">begin</span>&nbsp;<span style="color: maroon; ">try</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">insert</span>&nbsp;<span style="color: blue; ">into</span>&nbsp;<span style="color: maroon; ">[unbreakable_code]</span><span style="color: silver; ">.</span><span style="color: maroon; ">[flower]</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: maroon; ">(</span><span style="color: maroon; ">[flower]</span><span style="color: silver; ">,</span><span style="color: maroon; ">[color]</span><span style="color: maroon; ">)</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">values</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: maroon; ">(</span><span style="color: #8000FF; ">@flower</span><span style="color: silver; ">,</span><span style="color: #8000FF; ">@color</span><span style="color: maroon; ">)</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;Only&nbsp;commit&nbsp;the&nbsp;transaction&nbsp;starting&nbsp;within&nbsp;THIS&nbsp;procedure!</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;Using&nbsp;@@trancount&nbsp;will&nbsp;cause&nbsp;the&nbsp;calling&nbsp;unit&nbsp;unbreakable_code&nbsp;to&nbsp;fail</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;as&nbsp;a&nbsp;non-descriminate&nbsp;rollback&nbsp;will&nbsp;rollback&nbsp;the&nbsp;calling</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;transaction.&nbsp;Then,&nbsp;when&nbsp;the&nbsp;unit&nbsp;unbreakable_code&nbsp;tries&nbsp;to&nbsp;rollback&nbsp;it</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;will&nbsp;throw&nbsp;an&nbsp;error&nbsp;with&nbsp;a&nbsp;"transaction&nbsp;not&nbsp;found&nbsp;for&nbsp;rollback"</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">if</span>&nbsp;<span style="color: blue; ">exists</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: maroon; ">(</span><span style="color: blue; ">select</span>&nbsp;<span style="color: silver; ">*</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">from</span>&nbsp;&nbsp;&nbsp;<span style="color: maroon; ">[sys]</span><span style="color: silver; ">.</span><span style="color: maroon; ">[dm_tran_active_transactions]</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">where</span>&nbsp;&nbsp;<span style="color: maroon; ">[name]</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: #8000FF; ">@transaction</span><span style="color: maroon; ">)</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">begin</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">select</span>&nbsp;<span style="color: red; ">N'in&nbsp;process&nbsp;commit&nbsp;transaction&nbsp;('</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #8000FF; ">@transaction</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N')&nbsp;(('</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #FF0080; font-weight: bold; ">object_schema_name</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">@@procid</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'].['</span>&nbsp;<span style="color: silver; ">+</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">object_name</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">@@procid</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'])'</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">commit</span>&nbsp;<span style="color: blue; ">transaction</span>&nbsp;<span style="color: #8000FF; ">@transaction</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">end</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">end</span>&nbsp;<span style="color: maroon; ">try</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">begin</span>&nbsp;<span style="color: maroon; ">catch</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;Only&nbsp;rollback&nbsp;the&nbsp;transaction&nbsp;starting&nbsp;within&nbsp;THIS&nbsp;procedure!</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">set</span>&nbsp;<span style="color: #8000FF; ">@application_message</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: red; ">N'&#60;application_message>
<br/>			&#60;parameters>
<br/>				&#60;flower>'</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #8000FF; ">@flower</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">'&#60;/flower>
<br/>				&#60;color>'</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #8000FF; ">@color</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'&#60;/color>
<br/>			&#60;/parameters>&#60;/application_message>'</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">execute</span>&nbsp;<span style="color: maroon; ">[utility]</span><span style="color: silver; ">.</span><span style="color: #FF0080; font-weight: bold; ">[handle_error]</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #8000FF; ">@procedure_id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">@@procid</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@application_message</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: #8000FF; ">@application_message</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">,</span>&nbsp;<span style="color: #8000FF; ">@stack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">=</span><span style="color: #8000FF; ">@error_stack</span>&nbsp;<span style="color: maroon; ">output</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">if</span>&nbsp;<span style="color: blue; ">exists</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: maroon; ">(</span><span style="color: blue; ">select</span>&nbsp;<span style="color: silver; ">*</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">from</span>&nbsp;&nbsp;&nbsp;<span style="color: maroon; ">[sys]</span><span style="color: silver; ">.</span><span style="color: maroon; ">[dm_tran_active_transactions]</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">where</span>&nbsp;&nbsp;<span style="color: maroon; ">[name]</span>&nbsp;<span style="color: silver; ">=</span>&nbsp;<span style="color: #8000FF; ">@transaction</span><span style="color: maroon; ">)</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">begin</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">select</span>&nbsp;<span style="color: red; ">N'out&nbsp;of&nbsp;process&nbsp;rollback&nbsp;transaction&nbsp;('</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #8000FF; ">@transaction</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N')&nbsp;(('</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: #FF0080; font-weight: bold; ">object_schema_name</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">@@procid</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'].['</span>&nbsp;<span style="color: silver; ">+</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: fuchsia; font-style: italic; ">object_name</span><span style="color: maroon; ">(</span><span style="color: fuchsia; font-style: italic; ">@@procid</span><span style="color: maroon; ">)</span>&nbsp;<span style="color: silver; ">+</span>&nbsp;<span style="color: red; ">N'])'</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">rollback</span>&nbsp;<span style="color: blue; ">transaction</span>&nbsp;<span style="color: #8000FF; ">@transaction</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">end</span><span style="color: silver; ">;</span>
<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue; ">end</span>&nbsp;<span style="color: maroon; ">catch</span>
<br/>&nbsp;&nbsp;<span style="color: blue; ">end</span>
<br/><span style="color: maroon; ">go</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;&nbsp;code&nbsp;block&nbsp;end</span>
<br/><span style="color: green; font-style: italic; ">&#45;&#45;</span>
<br/>
</span></div>
